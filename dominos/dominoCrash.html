<!doctype html>
<html lang="en">
<head>
	<title>Domino Crash v1.0</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel=stylesheet href="../libs/base.css"/>
</head>
<body>

<script src="../libs/three.js"></script>
<script src="../libs/Detector.js"></script>
<script src="../libs/OrbitControls.js"></script>
<script src="../libs/FirstPersonControls.js"></script>
<script type="text/javascript" src="../libs/dat.gui.js"></script>
<script type="text/javascript" src="../libs/physi.js"></script>
<script type="text/javascript" src="../libs/stats.js"></script>
<script src="../libs/THREEx.KeyboardState.js"></script>
<script src="../libs/THREEx.FullScreen.js"></script>
<script src="../libs/THREEx.WindowResize.js"></script>
<script type="text/javascript" src="../libs/Projector.js"></script>
<!-- ------------------------------------------------------------ -->

<div id="ThreeJS" style="position: absolute; left:0px; top:0px"></div>
<script>

	'use strict';

	Physijs.scripts.worker = '../libs/physijs_worker.js';
	Physijs.scripts.ammo = '../libs/ammo.js';
	var collidableMeshList = [];
	var initScene, render, applyForce, setMousePosition, mouse_position,
	        ground_material, box_material,
	        renderer, render_stats, scene, ground, container, controls, controlsR, light, camera, box, boxes = [];
   var keyboard = new THREEx.KeyboardState();
   var clock = new THREE.Clock();
// custom global variables
   var cube;
   var dominos = [];
   //var projector, mouse = { x: 0, y: 0 }, INTERSECTED;
   var dominoSprite;
   var colorD;
   var addDom = false;
   var soundSample = false;

init();
animate();

// FUNCTIONS 		
function init() 
{
	// SCENE
	scene = new Physijs.Scene;
	scene.setGravity(new THREE.Vector3(0, -100, 0));
	// CAMERA
	var SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;
	var VIEW_ANGLE = 45, ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.1, FAR = 20000;
	camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);
	scene.add(camera);
	camera.position.set(0,150,400);
	camera.lookAt(scene.position);	
	// RENDERER
	if ( Detector.webgl )
		renderer = new THREE.WebGLRenderer( {antialias:true} );
	else
		renderer = new THREE.CanvasRenderer(); 
	renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
	container = document.getElementById( 'ThreeJS' );
	container.appendChild( renderer.domElement );
	// EVENTS
	THREEx.WindowResize(renderer, camera);
	THREEx.FullScreen.bindKey({ charCode : 'm'.charCodeAt(0) });
	// CONTROLS
	controls = new THREE.OrbitControls( camera, renderer.domElement );
	controlsR = new THREE.OrbitControls( camera, renderer.domElement );
	
	var cubeMaterial = new THREE.MeshLambertMaterial({color: 0xcd0000});
	var cubeMaterial2 = new THREE.MeshLambertMaterial({color: 0xcd0000, wireframe: true});
	var cubeGeometry = new THREE.BoxGeometry(5, 60, 25, 8, 8, 8, cubeMaterial);

	

	var projector = new THREE.Projector();
	document.addEventListener('mousedown', onDocumentMouseDown, false);
	document.addEventListener('mousemove', onDocumentMouseMove, false);
	document.addEventListener("keydown", onDocumentKeyDown, false);
	/*document.addEventListener('collision', function(object) {
	    sound1.play();
	  });*/

	controlsR = new function () {
	    this.showRay = true;
	};


	

	// LIGHT
	var light = new THREE.PointLight(0xffffff);
	light.position.set(0,250,0);
	scene.add(light);
	// FLOOR
	var floorTexture = new THREE.ImageUtils.loadTexture( '../assets/textures/annie-spratt-osuiatBDTww-unsplash.jpg' );
	floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping; 
	floorTexture.repeat.set( 1, 1 );
	var floorMaterial = Physijs.createMaterial(
                    new THREE.MeshPhongMaterial({map: floorTexture, side: THREE.DoubleSide}),
                    .9, .3);


	var floorGeometry = new Physijs.BoxMesh(new THREE.BoxGeometry(500, 3, 500), floorMaterial, 0);

	
	var floor = new Physijs.BoxMesh(new THREE.BoxGeometry(500, 500, 3), floorMaterial, 0);



	floor.position.y = -0.5;
	floor.rotation.x = Math.PI / 2;
	scene.add(floor);
	
	////////////
	// CUSTOM //
	////////////
	
	var imagePrefix = "../assets/textures/01_SPoW_051119.jpg";

	var skyGeometry = new THREE.CubeGeometry( 5000, 5000, 5000 );	
	
	var materialArray = [];
	for (var i = 0; i < 6; i++)
		materialArray.push( new THREE.MeshBasicMaterial({
			map: THREE.ImageUtils.loadTexture( imagePrefix ),
			side: THREE.BackSide
		}));
	var skyMaterial = new THREE.MeshFaceMaterial( materialArray );
	var skyBox = new THREE.Mesh( skyGeometry, skyMaterial );
	scene.add( skyBox );
    var cube = new THREE.Mesh(cubeGeometry, cubeMaterial);

        // position the cube
        cube.position.x = 0;
        cube.position.y = 30;
        cube.position.z = 0;

        // add the cube to the scene


      //  scene.add(cube);

/*     var listener = new THREE.AudioListener();
      camera.add(listener);
      var sound = new THREE.Audio( listener );
      var audioLoader = new THREE.AudioLoader();
		audioLoader.load( '../assets/audio/click.wav', function( buffer ) {
		sound.setBuffer( buffer );
		sound.setLoop( true );
		sound.setVolume( 0.5 );
		sound.play();
	}); */




	function onDocumentMouseDown(event) {
		var mouseButton;
		

	    var vector = new THREE.Vector3(( event.clientX / window.innerWidth ) * 2 - 1, -( event.clientY / window.innerHeight ) * 2 + 1, 0.5);
	    vector = vector.unproject(camera);

	    var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());

	    var intersects = raycaster.intersectObject(floor);
	  
	    if (intersects.length > 0) {
	    	//if (event.button == 0)


	    }

	    if (event.button == 1 && colorD == false && addDom == true) {

	    var domina = new Physijs.BoxMesh(cubeGeometry, Physijs.createMaterial(new THREE.MeshPhongMaterial(
                                {
                                    color: 0xcd0000,
                                   // transparent: true, opacity: 0.8,
		                          //map: THREE.ImageUtils.loadTexture( '../assets/textures/general/darker_wood.jpg' )
                                })));
	    domina.__dirtyRotation = true;
	    domina.position.y = 3.5;
	 
	    domina.position.x = intersects[0].point.x;
	    domina.position.y = intersects[0].point.y + 30;
	    domina.position.z = intersects[0].point.z;
	  
	    scene.add(domina); 
		dominos.push(domina);
	}

	var vector3 = new THREE.Vector3(( event.clientX / window.innerWidth ) * 2 - 1, -( event.clientY / window.innerHeight ) * 2 + 1, 0.5);
	vector3 = vector3.unproject(camera);
	var raycaster3 = new THREE.Raycaster(camera.position, vector3.sub(camera.position).normalize());
	for (var i=0; i<dominos.length; i++) {
		var intersects3 = raycaster3.intersectObject(dominos[i]);
		if(intersects3.length > 0 && event.button == 0) {
			for (var a=0; a<dominos.length; a++) {
				dominos[a].material.transparent = false;
				dominos[a].material.opacity = 1;
			}
			dominos[i].material.transparent = true;
			dominos[i].material.opacity = 0.5;

		}

		if(intersects3.length > 0 && event.button == 2) {
			dominos[i].rotation.x = 0.3;
			dominos[i].rotation.z = 0.3;
			dominos[i].__dirtyRotation = true;
			soundSample = true;
		}
	}


	}
	


	function onDocumentMouseMove(event) {
		
		var vector = new THREE.Vector3(( event.clientX / window.innerWidth ) * 2 - 1, -( event.clientY / window.innerHeight ) * 2 + 1, 0.5);
		vector = vector.unproject(camera);

		var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());

	//	var intersects = raycaster.intersectObject(skyBox);
		var intersects2 = raycaster.intersectObject(floor);
		
/*		console.log(intersects2);
		if(intersects2 == 'undefined')
		{cube.visibility = false;
			console.log('usao') }
		if(intersects == 'undefined')*/
		if(intersects2[1])
		cube.position.set( intersects2[1].point.x , intersects2[1].point.y + 30, intersects2[1].point.z )

	var originPoint = cube.position.clone();
	for (var vertexIndex = 0; vertexIndex < cube.geometry.vertices.length; vertexIndex++)
	{		
		var localVertex = cube.geometry.vertices[vertexIndex].clone();
		var globalVertex = localVertex.applyMatrix4( cube.matrix );
		var directionVector = globalVertex.sub( cube.position );
		
		var ray = new THREE.Raycaster( originPoint, directionVector.clone().normalize() );
		var collisionResults = ray.intersectObjects( dominos );
		if ( collisionResults.length > 0 && collisionResults[0].distance < directionVector.length() ) {
			cube.material.wireframe = true;
			colorD = true;
		}
		else{
			cube.material.wireframe = false;
			colorD = false;
		}
	}	

	

	}
	
	function onDocumentKeyDown(event){

		if ( keyboard.pressed("a") ) 
		{ 	
			scene.add(cube);
			addDom = true;
		}
		if ( keyboard.pressed("d") ) 
		{ 	
			scene.remove(cube);
			addDom = false;
		}
	}
}

function animate() 
{
    requestAnimationFrame( animate );
	render();		
	update();
}

function update()
{
	if ( keyboard.pressed("z") ) 
	{ 
	}
	
	
	
	
	controls.update();
}

function render() 
{	scene.simulate(undefined, 1);
	renderer.render( scene, camera );
}

</script>

</body>
</html>
